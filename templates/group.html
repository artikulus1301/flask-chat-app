{% extends 'base.html' %}

{% block title %}{{ group.name }} ‚Äî Secure Chat{% endblock %}

{% block content %}
<div class="group-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã -->
    <div class="group-header">
        <div class="group-info">
            <h1 id="group-name">{{ group.name }}</h1>
            <p id="group-description">{{ group.description|default("–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è", true) }}</p>

            <div class="group-meta">
                <span class="member-count">
                    üë• <span id="group-member-count">{{ group.members|length }}</span> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                </span>
                <span class="group-privacy">
                    {{ "üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è" if group.is_private else "üåê –ü—É–±–ª–∏—á–Ω–∞—è" }}
                </span>
            </div>
        </div>

        <div class="group-actions">
            {% if is_member %}
                <button id="leave-group-btn" class="btn-danger">–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</button>
            {% else %}
                <button id="join-group-btn" class="btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            {% endif %}
            
            {% if is_creator %}
                <button id="manage-group-btn" class="btn-secondary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
            {% endif %}
        </div>
    </div>

    <div class="group-chat-layout">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="group-sidebar">
            <section class="sidebar-section">
                <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                <div class="members-list" id="members-list">
                    {% for member in group.members %}
                    <div class="member-item" data-user-id="{{ member.id }}">
                        <span class="member-avatar">{{ member.username[0]|upper }}</span>
                        <span class="member-name">{{ member.username }}</span>
                        {% if member.id == group.created_by %}
                            <span class="member-role creator">üëë</span>
                        {% endif %}
                        <span class="online-status {{ 'online' if member.is_online else 'offline' }}"></span>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <section class="sidebar-section">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> {{ group.created_at.strftime('%d.%m.%Y') }}</p>
                <p><strong>UUID –≥—Ä—É–ø–ø—ã:</strong></p>
                <code id="group-uuid">{{ group.uuid }}</code>
                <button id="copy-uuid" class="btn-copy" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å UUID">üìã</button>
            </section>
        </aside>

        <!-- –ß–∞—Ç -->
        <section class="group-chat-area">
            <div class="chat-header">
                <h2>–ß–∞—Ç –≥—Ä—É–ø–ø—ã "{{ group.name }}"</h2>
                <div class="chat-info">
                    <span id="group-typing-indicator"></span>
                </div>
            </div>

            <div class="messages-container">
                <div id="group-messages" class="messages">
                    <div id="group-empty-state" class="empty-state">
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ</p>
                    </div>
                </div>
            </div>

            {% if is_member %}
            <div class="message-input-container">
                <div class="input-tools">
                    <button id="group-file-upload" class="btn-tool" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
                    <button id="group-encryption-toggle" class="btn-tool" title="–í–∫–ª—é—á–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ">üîì</button>
                </div>

                <div class="message-input-wrapper">
                    <textarea 
                        id="group-message-input" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                        rows="1" 
                        maxlength="2000"></textarea>
                    <button id="group-send-btn" class="btn-send">‚û§</button>
                </div>

                <div class="input-status">
                    <span id="group-char-count">0/2000</span>
                    <span id="group-encryption-status" class="encryption-off">–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ</span>
                </div>
            </div>
            {% else %}
            <div class="join-prompt">
                <p>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –≥—Ä—É–ø–ø–µ, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</p>
                <button id="prompt-join-btn" class="btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
            {% endif %}
        </section>
    </div>
</div>

{% if is_creator %}
<div id="manage-group-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="manage-group-form">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="edit-group-name" value="{{ group.name }}" maxlength="100">

                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="edit-group-description" maxlength="500">{{ group.description or '' }}</textarea>

                <label>
                    <input type="checkbox" id="edit-group-private" {% if group.is_private %}checked{% endif %}>
                    –ü—Ä–∏–≤–∞—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞
                </label>

                <div class="form-actions">
                    <button type="button" id="delete-group-btn" class="btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                    <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<input type="file" id="group-file-input" style="display:none" multiple>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    if (typeof CURRENT_USER === 'undefined' || !CURRENT_USER.uuid) {
        window.location.href = '/auth';
        return;
    }

    const GROUP_DATA = {
        id: {{ group.id }},
        uuid: "{{ group.uuid }}",
        name: "{{ group.name }}",
        is_private: {{ 'true' if group.is_private else 'false' }},
        is_member: {{ 'true' if is_member else 'false' }},
        is_creator: {{ 'true' if is_creator else 'false' }},
        created_by: {{ group.created_by }}
    };

    if (typeof initializeGroupChat === 'function') {
        initializeGroupChat(GROUP_DATA);
    } else {
        console.warn('‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è initializeGroupChat –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –ø–æ–¥–∫–ª—é—á–∏ app.js');
    }
});
</script>
{% endblock %}
