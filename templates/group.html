<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure-Chat</title>
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- SocketIO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- CryptoJS –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
<div class="group-container">
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ -->
    <div class="group-header">
        <div class="group-info">
            <h1 id="group-name">{{ group.name }}</h1>
            <p id="group-description">{{ group.description or "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è" }}</p>
            <div class="group-meta">
                <span class="member-count">
                    üë• <span id="group-member-count">{{ group.members|length }}</span> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                </span>
                <span class="group-privacy">
                    {% if group.is_private %}
                    üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è
                    {% else %}
                    üåê –ü—É–±–ª–∏—á–Ω–∞—è
                    {% endif %}
                </span>
            </div>
        </div>
        
        <div class="group-actions">
            {% if is_member %}
            <button id="leave-group-btn" class="btn-danger">–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</button>
            {% else %}
            <button id="join-group-btn" class="btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            {% endif %}
            
            {% if is_creator %}
            <button id="manage-group-btn" class="btn-secondary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
            {% endif %}
        </div>
    </div>

    <div class="group-chat-layout">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ -->
        <div class="group-sidebar">
            <div class="sidebar-section">
                <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                <div class="members-list" id="members-list">
                    {% for member in group.members %}
                    <div class="member-item" data-user-id="{{ member.id }}">
                        <span class="member-avatar">{{ member.username[0]|upper }}</span>
                        <span class="member-name">{{ member.username }}</span>
                        {% if member.id == group.created_by %}
                        <span class="member-role creator">üëë</span>
                        {% endif %}
                        {% if member.is_online %}
                        <span class="online-status online"></span>
                        {% else %}
                        <span class="online-status offline"></span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ -->
            <div class="sidebar-section">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <div class="group-details">
                    <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> <span id="group-created">{{ group.created_at.strftime('%d.%m.%Y') }}</span></p>
                    <p><strong>UUID –≥—Ä—É–ø–ø—ã:</strong></p>
                    <code class="group-uuid">{{ group.uuid }}</code>
                    <button id="copy-uuid" class="btn-copy" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å UUID">
                        üìã
                    </button>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
        <div class="group-chat-area">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
            <div class="chat-header">
                <h2>–ß–∞—Ç –≥—Ä—É–ø–ø—ã "{{ group.name }}"</h2>
                <div class="chat-info">
                    <span id="group-typing-indicator"></span>
                </div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="messages-container">
                <div class="messages" id="group-messages">
                    <div class="empty-state" id="group-empty-state">
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ</p>
                    </div>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            {% if is_member %}
            <div class="message-input-container">
                <div class="input-tools">
                    <button class="btn-tool" id="group-file-upload" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">
                        üìé
                    </button>
                    <button class="btn-tool" id="group-encryption-toggle" title="–í–∫–ª—é—á–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ">
                        üîì
                    </button>
                </div>
                
                <div class="message-input-wrapper">
                    <textarea 
                        id="group-message-input" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã..." 
                        rows="1"
                        maxlength="2000"
                        {% if not is_member %}disabled{% endif %}
                    ></textarea>
                    <button id="group-send-btn" class="btn-send" {% if not is_member %}disabled{% endif %}>
                        ‚û§
                    </button>
                </div>
                
                <div class="input-status">
                    <span id="group-char-count">0/2000</span>
                    <span id="group-encryption-status" class="encryption-off">–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ</span>
                </div>
            </div>
            {% else %}
            <div class="join-prompt">
                <p>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –≥—Ä—É–ø–ø–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</p>
                <button id="prompt-join-btn" class="btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–æ–π -->
{% if is_creator %}
<div id="manage-group-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="manage-group-form">
                <div class="form-group">
                    <label for="edit-group-name">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                    <input type="text" id="edit-group-name" value="{{ group.name }}" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="edit-group-description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="edit-group-description" rows="3" maxlength="500">{{ group.description or '' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="edit-group-private" {% if group.is_private %}checked{% endif %}>
                        <span class="checkmark"></span>
                        –ü—Ä–∏–≤–∞—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-danger" id="delete-group-btn">–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
                    <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
<input type="file" id="group-file-input" style="display: none;" multiple>

{% endblock %}

{% block scripts %}
<script>
    const GROUP_DATA = {
        id: {{ group.id }},
        uuid: "{{ group.uuid }}",
        name: "{{ group.name }}",
        is_private: {{ 'true' if group.is_private else 'false' }},
        is_member: {{ 'true' if is_member else 'false' }},
        is_creator: {{ 'true' if is_creator else 'false' }},
        created_by: {{ group.created_by }}
    };

    document.addEventListener('DOMContentLoaded', function() {
        if (!CURRENT_USER.uuid) {
            window.location.href = '/auth';
            return;
        }

        initializeGroupChat();
    });

    function initializeGroupChat() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞
        connectToGroup();
        loadGroupMessages();
        setupGroupEventListeners();
    }

    function connectToGroup() {
        if (GROUP_DATA.is_member) {
            socket.emit('join_room', { group_uuid: GROUP_DATA.uuid });
        }
    }

    function setupGroupEventListeners() {
        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è/–≤—ã—Ö–æ–¥–∞
        if (GROUP_DATA.is_member) {
            document.getElementById('leave-group-btn').addEventListener('click', leaveGroup);
        } else {
            document.getElementById('join-group-btn').addEventListener('click', joinGroup);
            document.getElementById('prompt-join-btn').addEventListener('click', joinGroup);
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π (–¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è)
        if (GROUP_DATA.is_creator) {
            document.getElementById('manage-group-btn').addEventListener('click', openManageModal);
            document.getElementById('manage-group-form').addEventListener('submit', updateGroup);
            document.getElementById('delete-group-btn').addEventListener('click', deleteGroup);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        if (GROUP_DATA.is_member) {
            document.getElementById('group-send-btn').addEventListener('click', sendGroupMessage);
            document.getElementById('group-message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendGroupMessage();
                }
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            document.getElementById('group-file-upload').addEventListener('click', function() {
                document.getElementById('group-file-input').click();
            });
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ UUID
        document.getElementById('copy-uuid').addEventListener('click', function() {
            navigator.clipboard.writeText(GROUP_DATA.uuid).then(function() {
                alert('UUID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            });
        });
    }

    async function joinGroup() {
        try {
            const response = await fetch(`/groups/${GROUP_DATA.uuid}/join`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
        }
    }

    async function leaveGroup() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É?')) {
            return;
        }

        try {
            const response = await fetch(`/groups/${GROUP_DATA.uuid}/leave`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                window.location.href = '/';
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
        }
    }
</script>
</body>
</html>