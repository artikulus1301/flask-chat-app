import multiprocessing
import os

# ─────────────────────────────────────────────
# 🔧 Базовые настройки сервера
# ─────────────────────────────────────────────
bind = os.getenv("GUNICORN_BIND", "0.0.0.0:5000")
backlog = 2048  # Очередь входящих подключений

# ─────────────────────────────────────────────
# ⚙️ Рабочие процессы (workers)
# ─────────────────────────────────────────────
# Для Flask-SocketIO рекомендуется eventlet
worker_class = "eventlet"

# Количество воркеров — 2 x CPU + 1 (или 1 для контейнера)
cpu_count = multiprocessing.cpu_count()
workers = int(os.getenv("GUNICORN_WORKERS", (cpu_count * 2) + 1))

# Количество одновременных соединений на воркер
worker_connections = int(os.getenv("GUNICORN_WORKER_CONNECTIONS", 1000))

# Перезапуск воркера после N запросов (предотвращает утечки памяти)
max_requests = 1000
max_requests_jitter = 50

# ─────────────────────────────────────────────
# 🕒 Таймауты и соединения
# ─────────────────────────────────────────────
timeout = int(os.getenv("GUNICORN_TIMEOUT", 60))  # время ожидания запроса
graceful_timeout = 30
keepalive = 5

# ─────────────────────────────────────────────
# 📜 Логи
# ─────────────────────────────────────────────
accesslog = "-"  # STDOUT
errorlog = "-"   # STDERR
loglevel = os.getenv("GUNICORN_LOGLEVEL", "info")

# ─────────────────────────────────────────────
# 📦 Управление процессом
# ─────────────────────────────────────────────
proc_name = "secure_chat_app"
daemon = False
pidfile = None
umask = 0

# ─────────────────────────────────────────────
# 🧑‍💻 Права и пользователи
# ─────────────────────────────────────────────
user = None
group = None

# ─────────────────────────────────────────────
# 📁 Временная директория (для upload'ов)
# ─────────────────────────────────────────────
tmp_upload_dir = "/tmp"  # или None

# ─────────────────────────────────────────────
# 🔒 SSL (активировать при необходимости)
# ─────────────────────────────────────────────
# keyfile = "/path/to/ssl/key.pem"
# certfile = "/path/to/ssl/cert.pem"
# ca_certs = "/path/to/ssl/ca.pem"
# ciphers = "ECDHE+AESGCM"

# ─────────────────────────────────────────────
# 🧩 Прочее
# ─────────────────────────────────────────────
reload = False  # True = автообновление кода (только для разработки)
